% A tervezés részletes leírása, a döntési lehetőségek értékelése és a választott megoldások indoklása

\chapter{Tervezés}

\section{Főbb tervezési szempontok}

A tervezésnél a fő szempontok az egyszerű kezelés és a sebesség voltak. Elsősorban a Photoshop szkript működését és hibáit szerettem volna figyelembe venni, hogy akik már tisztában vannak a használatával, azoknak ne jelentsen kihívást áttérni az új alternatívára, és hogy egy kellemesebb felhasználói élményt nyújtson. 

A szkript egy nagy előnye volt, hogy egy terminál helyett egy felhasználói felülete volt, és hogy mentés előtt láthattuk, hogy mit fog eredményezni a generálás. Sajnos ha elrontottunk egy paramétert, akkor az egész folyamatot elölről kellett kezdenünk, ami felettébb bosszantó volt. 

Ugyan a szkript képes volt több különböző képet kezelni, az erre készült megoldás igencsak fapados volt: a mennyiséget a szkript egy szorzóként kezelte. Ez azt jelentette, hogy nem adhattuk meg egyesével, hogy miből mennyit szeretnénk, mindenből ugyanannyit kaptunk.

Szerencsére nem volt gyakori eset, de előfordult már, hogy egy új előbállítást szerettünk volna felvenni a szkriptbe. Sajnos ehhez bele kellett nyúlnunk a szkriptbe, ahol ugyan igyekeztem ezeket egy külön forrásfájlba gyűjteni, de ez is csak egy kényszermegoldás volt. Egy ennél is primitívebb megoldás volt, ahogy bizonyos beállításcsoportok előbeállításának megválasztása kihatással volt más beállításcsoportokra, pl. egy matrica előbeállítás kiválasztása nem csak a matrica méretét határozta meg, hanem dokumentumszinten is megváltoztatta a képpontsűrűséget. Ezt a szkript úgy oldotta meg, hogy egy előbeállítás kiválasztásánál külön megvizsgálta a kiválasztott beállítást, és aszerint állította át a felhasználói felület többi területét. Ennek a konfigurálása a legkevésbé sem volt triviális, egy felhasználó nem tudná, hova kellene hozzáadni a feltételeket, és hogy azok milyen esetleges mellékhatásokkal járhatnak. 

\section{Paraméterek és csoportosításuk}

A feladatomhoz elengedhetetlen volt a mélyremenő és konfiguráció lehetősége, egy nyomtatásnál megannyi paramétert kell figyelembe vennünk. Ezeket a paramétereket célszerű volt valamilyen módon csoportosítani. A szkript eredetileg csak kétféle előbállításcsoportot kezelt: papírtekercs és cellaméret előbeállítások. Ezek reprezentációra nekem is szükségem volt, de a beállításokat tovább bontottam, tekintve a program bővíthetőségére.

\subsection{A dokumentum paraméterei}

A dokumentum beállításai talán a szkriptben a papírtekercs beállításainak feleltethetők meg. A dokumentum tulajdonságaihoz az alábbi dolgok tartoznak:

\begin{itemize}
    \item a dokumentum szélessége, avagy a papírtekercs szélessége.
    \item a dokumentum pixelsűrűsége\footnote{A pixelsűrűség az egységnyi hosszra eső pixelek száma.},
    \item a margók mérete,
    \item a segédvonalak beállításai,
    \begin{itemize}
        \item a segédvonalak léte,
        \item a segédvonalak vastagsága,
        \item a segédvonalak belógása,
    \end{itemize}
    \item az darabszám korrigálása\footnote{A darabszám korrigálása csak egyetlen forrásfájl esetén releváns.}.
\end{itemize}

Megoldható lett volna, hogy a segédvonalakat képenként lehessen állítani, de mivel ez szinte sosem merült fel, és mert legtöbbször minden képre vonatkozóan szeretnénk állítani segédvonalakat, ezért ezek a beállítások a dokumentum beállításai alá kerültek. 

\subsubsection{A nyomtató paraméterei}

Van pár paraméter, ami függ a nyomtató típusától, például a margók, a minimum illetve maximum dokumentummagasság.
A nyomtatónk tud teljes tekercsszélességben is nyomtatni, de ez kevésbé hatékony és nem feltétlenül igaz minden nyomtatóra. Az alapértelmezett margó eszköztípusonként eltérhet. Ugyan algoritmuselméleti szemponból a tekercset végtelennek tekintjük, a valóságban sajnos korlátokba ütközünk. Egyfelől a nyomtató (esetünkben ez kb. 18 méter), másfelől a hátralevő papírtekercs hossza is köt minket.
Ezek olyan paraméterek, amiket nem szerettem volna a forráskódba égetni, ismét csak azért, ha esetleg másik nyomdában eltérő értékük lenne, vagy esetleg nekünk kellene egy másik plotteren nyomtatnunk. Ezeket a paramétereket külön előbeállításcsoportként kezeljük, és főként bővíthetőségi okokból lettek különvéve.

\subsection{A képek paraméterei}

A szkript hibájából tanulva a képek maraméterei képenként állíthatók. Egy adott kép paramétereihez tartoznak: 

\begin{itemize}
    \item a mennyiség,
    \item a kép fizikai szélessége és magassága,
    \item a kép maszkja.
\end{itemize}

\subsubsection{A kép maszkja}

Képszerkesztésben amikor egy maszkról beszélünk, akkor egy olyan rétegre gondolunk, mely meghatározza, hogy a kép mely részei láthatók. A maszk egy szürkeárnyalatos kép, ahol a fekete pixelek kitakarják, a fehér pixelek átengedig, a szürke pixelek pedig részlegesen eresztik át a kép tartalmát az értéküktől függően. 

TODO kép

Feltételezzük, hogy a maszk és a maszkolni kívánt kép méretei megegyeznek. Tekintsük a szürkeárnyalatos pixeleket $1$ és $0$ közötti értékeknek, ahol a fehér pixelek értéke a legmagasabb.
Ezek alapján, ha $k$ képet $m$ maszkkal szeretnénk maszkolni, úgy az eredmény $k'$, ahol a kép minden $i, j$ pixelének alfa csatornájanak értéke:

$$k'_\alpha(i, j) = k_\alpha(i, j) * m(i, j).$$

Kitűzők és matricák nyomtatásánál általában valamilyen kör alakú formára vágjuk fel a kinyomtatott képeket, ezért a szkriptben lehetőség volt ezeket a képeket egy kör alakú mintával maszkolni, így eredménynek egy kör alakú képet kaptunk.

Vitatható, hogy a maszkolás mennyire tartozik a program feladatkörébe. Egyfelől vannak erre specializálódó programok, és jobb, ha előre látjuk, hogy hogyan lesz körbevágva a képünk. Másfelől ez egy olyan funkció volt, melyet nem akartam kivenni, mivel általában nem kaptuk meg az előre maszkolt képeket a rendeléseknél. A kör alak sokszor elősegíti a vágást és lehet, hogy spórolni is tudunk a tintával, hiszen így semmiképpen sem fogunk a levágott részekre nyomtatni. 
Ezek miatt úgy döntöttem, hogy megtartom ezt a funkcionalitást.

A maszkhoz tartozó előbeállítás tartalmazza a maszk képének elérési útvonalát. Ez az előbeállítás is főként bővíthetőségi okok miatt lett különvéve.

\section{Kaszkádos előbeállítások}

A paraméterek nagyon gyakran valamilyen szabványnak vagy előre megadott értéknek felelnek meg. Ez különösen igaz a képek méretére (pl. A4-es szabvány) és a papírtekercsek méretére. Ezeknek a méreteknek nem szeretnénk mindig utánajárni, és fejben tartani sem egyszerű, ezért nagy segítség, ha a legtöbbet használt méretekhez és konfigurációkhoz előbállításokat nyújtunk. Ezeket az előbeállítások fájlokból célszerű beolvasni, hogy azt felhasználók is szerkeszteni illetve bővíteni tudják a program újrafordítása nélkül. Ez a flexibilitás elősegíti, hogy más nyomták is egyszerűen át tudjanak térni a program használatára, és hogy a ha a jövőben esetleg másik nyomtatón kellene dolgoznunk, akkor ne jelentsen sok munkát az arra történő áttérés.

Mind a négy beállításcsoporthoz tartozhatnak előbeállítások, amiket valamilyen fájlból töltünk be, adott séma alapján. 
Egy másik apró, de nagyon hasznosnak bizonyuló ötlet volt, hogy ne legyen kötelező minden paramétert megadni egy előbeállítás fájlban, és hogy ezekre az értékekre ne legyen hatással a beállítás betöltésének folyamata, ne vesszenek el az esetleg eddig beállított értékeink, ahol nem muszáj. Ez tehát azt jelentette, hogy valamilyen félig strukturált módon érdemes tárolnunk az előbeállításokat, pl. kulcs-érték formában.

Semmiképpen sem szerettem volna elengedni, hogy egy előbeállítás betöltésekor másik beállításcsoportokra is hatással lehessünk. Az ötletem az volt, hogy adott előbeállítás fájlok magukban tartalmazhassanak más csoportokhoz tarzotó paramétereket, mint alcsoportok vagy referenciák más fájlokra. Betöltéskor megvizsgáljuk, hogy a fájl tartalmaz-e alcsoportokat, és ha igen, az alcsoport tartalmát továbbadjuk a megfelelő beállításcsoportér felelő komponensnek, ahol az betöltésre kerül. A cél az lenne, hogy az alcsoportok sémája megegyezzen az adott beállításcsoport sámájával, így továbbadáskor a komponensnek nem kell tudatában lennie, hogy alcsoportot tölt éppen be, vagy sem.

\section{Osztályarchitekúra}

A program architektúrájának tervezésekor nagy hangsúlyt kapott a teljesítmény. 

mindent csak egyszer tárolunk, mindent csak egyszer szűrünk stb.

optimalizációs megfontolások
ügyelés a bővíthetőségre

\section{A felhasználói felület}

mit akartam látni a uion, ui megfontolások
TODO ui vázlat

A tervezéshez UML diagramokat készítettem. 


A projekt a \texttt{printf} nevet kapta.

\begin{figure}[h]
    \centering
    \includegraphics[width=15cm]{figures/uml/img_source.pdf}
    \label{fig:ImageSource_uml}
\end{figure}

\begin{figure}[h]
    \centering
    \includegraphics[width=12cm]{figures/uml/tiling.pdf}
    \label{fig:Tiling_uml}
\end{figure}

\begin{figure}[h]
    \centering
    \includegraphics[width=14cm]{figures/uml/ui.pdf}
    \label{fig:UI_uml}
\end{figure}


\section{Kép betöltés, konfigurálás}

A bemeneti képeket tartalmazó és manipuláló osztályok tervezésénél különösen nagy hangsúlyt helyeztem a teljesítményre. Az \href{fig:ImageSource_uml}{ábrán} látszik, hogy a forrásfájlokat pixelenként tároljuk, és számon tartjuk a hozzájuk tartozó filtereket. A filterek tudják transzformálni és manipulálni a képet (pl. méret, forgatás, maszk, segédvonalak). Az eredeti képet mindig megőrizzük, hogy a filterek ne legyenek destruktívak. Annak érdekében, hogy a filtereket ne kelljen minden egyes elérésnél újra számolni vezettem be egy cachet. Ha változnak a filterek, a cache piszkos lesz, és a következő elérésnél újra számolódik.

Ennek fényében úgy döntöttünk, hogy támogatjuk mindkét megközelítést, és majd a felhasználó dönt a különböző algoritmusok között. Erre a célra szolgál egy Tiling interface, ami megkapja a képek listáját és a dokumentum tulajdonságait.

\section{A felhasználói felület}

A legnagyobb szabadságunk a felhasználói felület kapcsán volt. Mindenképpen szerettem volna egy előnézetet, hogy még mentés előtt a felhasználó láthassa az eredményt, és azt esetleg javítani tudja a beállítások újra konfigurálásával. A kezelés lépéseinek sorrendje alapján igyekeztem kialakítani a felület többi részét. Vannak bemeneti képeink, azokat szeretnénk egyesíteni, majd kinyomtatni. Képek, egyben, nyomtatás. Ezeket balról jobbra elrendezve kapjuk meg a felület végleges tervét: balra a bemenetek és azok beállításai, középen egy előnézet, jobbra pedig a kimenet (generált dokumentum) beállításai, a generálás és az exportálás/nyomtatás gomb. A UI feladata lenne továbbá az előbeállítások betöltése és a filterek beállításainak kezelése is. A bemenetek alapján meghívódik a generálás, ami elkészíti nekünk a kívánt képet, ezt fogjuk látni az előnézeten.

Az említett előbeállítások valamilyen fájlból betölthető konfigurációk, melyek vonatkozhatnak a bemenő képekre, a kimenő dokumentumra, valamint esetlegesen a nyomtatóra. Ezzel megoldható, hogy ne kelljen fejben tartanunk a tekercsek és a papírok szabványainak méretét.


